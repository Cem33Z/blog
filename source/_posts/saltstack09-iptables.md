---
title: "SaltStack实践08-系统参数修改sysctl.conf&ulimit&SElinux"
date: 2017-11.03 09:12:00
tags: [SaltStack]
---

## 环境说明
OS: CentOS-6.9-x86_64-minimal
SaltStack: Master/Minions version-2017.7.2

## 在 pillar 里配置防火墙规则
```
# /data/salt/pillar/top.sls 
base:
    "*":
      - sshd

# /data/salt/pillar/sshd/init.sls 
firewall:
  sshd_firewall:
    port: 22
    allow:
      - 192.168.0.0/24
```
<!--more-->
## 编写 .sls 状态文件
```
# /data/salt/base/init/iptables/init.sls

# Allow localhost
allow-localhost:
  iptables.insert:
    - in-interface: lo
    - table: filter
    - chain: INPUT
    - position: 1
    - jump: ACCEPT
    - save: True

# Allow ICMP
allow-icmp:
  iptables.insert:
    - table: filter
    - chain: INPUT
    - position: 2
    - proto: icmp
    - jump: ACCEPT
    - save: True

# Allow RELATED,ESTABLISHED
allow-state:
  iptables.insert:
    - table: filter
    - chain: INPUT
    - position: 3
    - match: state
    - connstate: 'RELATED,ESTABLISHED'
    - jump: ACCEPT
    - save: True
{% for eachfw, fw_rule in pillar['firewall'].iteritems() %}
# Add custom chain
{{ eachfw }}-chain:
  iptables.chain_present:
    #- name: {{ eachfw }}-chain
    - family: ipv4
    # - save: True
# Custom chain rules
{% if 'allow' in fw_rule %}
# White Lists
{% for each_allow in fw_rule['allow'] %}
{{ eachfw }}_allow_{{ each_allow }}:
  iptables.insert:
    - table: filter
    - chain: {{ eachfw }}-chain
    - position: 1
    - source: {{ each_allow }}
    - jump: ACCEPT
    - require:
      - iptables: {{ eachfw }}-chain
    - require_in:
      - iptables: {{ eachfw }}_deny
    - save: True
{% endfor %}
# Deny all
{{ eachfw }}_deny:
  iptables.append:
    - table: filter
    - chain: {{ eachfw }}-chain
    - jump: DROP
    - save: True

{% elif 'deny' in fw_rule %}
# Black Lists
{% for each_deny in fw_rule['deny'] %}
{{ eachfw }}_deny_{{ each_deny }}:
  iptables.insert:
    - table: filter
    - chain: {{ eachfw }}-chain
    - position: 1
    - source: {{ each_deny }}
    - jump: DROP
    - require:
      - iptables: {{ eachfw }}-chain
    - require_in:
      - iptables: {{ eachfw }}_allow
    - save: True
{% endfor %}
# Accept all
{{ eachfw }}_allow:
  iptables.append:
    - table: filter
    - chain: {{ eachfw }}-chain
    - jump: ACCEPT
    - save: True
{% endif %}

# Export traffic to custom chain
{{ eachfw }}-main:
  iptables.insert:
    - table: filter
    - chain: INPUT
    - position: 1
    - proto: tcp
    - dport: {{ fw_rule['port'] }}
    - jump: {{ eachfw }}-chain
{% endfor %}
```

## Test
### 关闭指定 minion 的防火墙或清空规则
```
[root@xxx-salt-master ~]# salt 'xxx-salt-minion-01' cmd.run 'service iptables stop'
xxx-salt-minion-01:
    iptables: Setting chains to policy ACCEPT: filter [  OK  ]
    iptables: Flushing firewall rules: [  OK  ]
    iptables: Unloading modules: [  OK  ]

[root@xxx-salt-master ~]# salt 'xxx-salt-minion-01' cmd.run 'iptables -nL --line'
xxx-salt-minion-01:
    Chain INPUT (policy ACCEPT)
    num  target     prot opt source               destination         
    
    Chain FORWARD (policy ACCEPT)
    num  target     prot opt source               destination         
    
    Chain OUTPUT (policy ACCEPT)
    num  target     prot opt source               destination
```

### 应用状态文件
```
[root@xxx-salt-master ~]# salt 'xxx-salt-minion-01' state.sls init.iptables
```

### 查看指定 minion 的防火墙规则是否应用生效
```
[root@xxx-salt-master ~]# salt 'xxx-salt-minion-01' cmd.run 'iptables-save'
xxx-salt-minion-01:
    # Generated by iptables-save v1.4.7 on Mon Oct 30 10:27:54 2017
    *filter
    :INPUT ACCEPT [67:6860]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [14:2596]
    :sshd_firewall-chain - [0:0]
    -A INPUT -i lo -j ACCEPT 
    -A INPUT -p icmp -j ACCEPT 
    -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
    -A sshd_firewall-chain -s 192.168.0.0/24 -j ACCEPT 
    -A sshd_firewall-chain -j DROP 
    COMMIT
    # Completed on Mon Oct 30 10:27:54 2017

# 重启试试
[root@xxx-salt-master ~]# salt 'xxx-salt-minion-01' cmd.run '/etc/init.d/iptables restart'
xxx-salt-minion-01:
    iptables: Setting chains to policy ACCEPT: filter [  OK  ]
    iptables: Flushing firewall rules: [  OK  ]
    iptables: Unloading modules: [  OK  ]
    iptables: Applying firewall rules: [  OK  ]

[root@xxx-salt-master ~]# salt 'xxx-salt-minion-01' cmd.run 'iptables-save'
xxx-salt-minion-01:
    # Generated by iptables-save v1.4.7 on Mon Oct 30 10:28:31 2017
    *filter
    :INPUT ACCEPT [8:1063]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [10:1044]
    :sshd_firewall-chain - [0:0]
    -A INPUT -i lo -j ACCEPT 
    -A INPUT -p icmp -j ACCEPT 
    -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
    -A sshd_firewall-chain -s 192.168.0.0/24 -j ACCEPT 
    -A sshd_firewall-chain -j DROP 
    COMMIT
    # Completed on Mon Oct 30 10:28:31 2017
```

## 参考资料
>[Salt State](http://www.jianshu.com/p/9196d51d027f)
>[SALT.STATES.IPTABLES](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.iptables.html)
>[基于Salt管理iptables防火墙规则](http://pengyao.org/managing-firewall-with-salt.html)
